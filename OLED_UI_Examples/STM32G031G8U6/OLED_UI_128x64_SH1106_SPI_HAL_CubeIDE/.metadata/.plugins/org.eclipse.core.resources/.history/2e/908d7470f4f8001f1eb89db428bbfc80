/*
 * usermain.c
 *
 *  Created on: Nov 27, 2024
 *      Author: tonny
 */
#include "ui.h"
#include "usermain.h"
#include "ADS1231.h"
#include "soft_timer.h"
#include "stm32g0xx_hal.h"
#include "oled.h"
#include "acc.h"
#include "LIS2DH12.h"
#include "scale.h"
#include "misc.h"
#include "flash.h"

// 定时器句柄
extern TIM_HandleTypeDef htim16;

// 看门狗句柄
//extern WWDG_HandleTypeDef hwwdg;

device_setting_t device_setting;

void usermain()
{
	

	Flash_Read_Struct(&device_setting, sizeof(device_setting_t));

	// 检测是否已经初始化
	if (device_setting.magic != 0x34382766)
	{
		// 有数据但数据有问题，先擦除
		if(device_setting.magic != 0xFFFFFFFF)
		{
			Flash_Erase(FLASH_LAST_PAGE);
		}
		// 未初始化
		device_setting.magic = 0x34382766;
		device_setting.scrn_brightness = 2;
		device_setting.scrn_saver_time = 30;
		device_setting.scrn_sleep_time = 60;
		device_setting.history_record = 1;
		device_setting.sys_cali_data.is_calibrated = 0;
		device_setting.sys_cali_data.zero_value = 0;
		device_setting.sys_cali_data.multiplier = 1.0;
		Flash_Write_Struct(&device_setting, sizeof(device_setting_t));
	}

	// 初始化自动保存
	Flash_Init();

	// init
	//开启外围器件
	// 注意：开启外围器件可能导致电压波动，不要在此操作之后立即读写Flash
	HAL_GPIO_WritePin(PWRON_GPIO_Port, PWRON_Pin, 0);
	// 软件定时器
	// 初始化
	soft_timer_init();

	HAL_Delay(100);

	//HAL_GPIO_WritePin(PWRON_GPIO_Port, PWRON_Pin, 0);

	//HAL_Delay(100);

	// 初始化UI
	DisplayInit();
	// 初始化ADS1231
	ADS1231_Init();
	// 初始化称重
	scale_init();
	// 初始化姿态仪
	LIS2DH12_init();
	// 初始化电池等
	Misc_init();
	// 初始化按钮
	BTN_init();
	// 初始化菜单
	reset_menu();


	// 开启定时器:编号0,周期模式,500ms,空回调函数,无参数
	soft_timer_start(SOFT_TIMER_0_SCALE, SOFT_TIMER_MODE_PERIODIC, 500, scale_timer_callback, NULL, 0);
	soft_timer_start(SOFT_TIMER_2_MISC_TASK, SOFT_TIMER_MODE_PERIODIC, 1000, MiscTask, NULL, 0);
	for (;;)
	{
		// loop
		DisplayTask();	// 绘制显存
		OLED_Refresh(); // 显存发送

		AccTask(); // 姿态传感器读取

		ScaleTask(); // ADS1231读取

		BtnTask(); // 按钮检测

		// 更新软件定时器状态
		soft_timer_update();

		// 喂狗
		//HAL_WWDG_Refresh(&hwwdg);

	}
}
