#include "LIS2DH12.h"
#include "main.h"
// osThreadId accTaskHandle;
LIS2DH12_data_t volatile LIS2DH12_data;
LIS2DH12_data_t volatile LIS2DH12_raw_data;
// extern osMutexId ReadAccMutexHandle;
// extern osThreadId accTaskHandle;

//extern uint8_t volatile AccNewDataFlag;
void AccTask()
{
	static double volatile x = 0, y = 0, z = 0;
	static int i;
	// TODO: 初始化数据。需要排除前面的0。需要设置超时。

	// loop

	//等待LIS2DH12数据就绪
	//if(AccNewDataFlag)
	if(HAL_GPIO_ReadPin(LIS_INT1_GPIO_Port, LIS_INT1_Pin))
	{
		//AccNewDataFlag = 0;
		LIS2DH12_get_value(&LIS2DH12_raw_data);
		x += (LIS2DH12_raw_data.x / (double)LIS2DH12_ODR_HZ);
		y += (LIS2DH12_raw_data.y / (double)LIS2DH12_ODR_HZ);
		z += (LIS2DH12_raw_data.z / (double)LIS2DH12_ODR_HZ);
		i++;
		if (i >= LIS2DH12_ODR_HZ)
		{
			i = 0;

			// 写入新数据
			LIS2DH12_data.x = (uint32_t)x;
			LIS2DH12_data.y = (uint32_t)y;
			LIS2DH12_data.z = (uint32_t)z;
			x = 0;
			y = 0;
			z = 0;
			// TODO: 计算设备方向和正反
		}
	}
}
