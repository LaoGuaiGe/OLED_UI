/*
 * usermain.c
 *
 *  Created on: Nov 27, 2024
 *      Author: tonny
 */
#include "ui.h"
#include "usermain.h"
#include "ADS1231.h"
#include "soft_timer.h"
#include "stm32g0xx_hal.h"
#include "oled.h"
#include "acc.h"
#include "LIS2DH12.h"
#include "scale.h"
#include "misc.h"
#include "flash.h"

// 定时器句柄
extern TIM_HandleTypeDef htim16;

// 看门狗句柄
//extern WWDG_HandleTypeDef hwwdg;

device_setting_t device_setting;

void usermain()
{
	// init
	//开启外围器件
	// 注意：开启外围器件可能导致电压波动，不要在此操作之后立即读写Flash
	HAL_GPIO_WritePin(PWRON_GPIO_Port, PWRON_Pin, 0);


	HAL_Delay(100);


	// 初始化UI
	DisplayInit();

	BTN_init();
	// 初始化菜单
	reset_menu();


	// 开启定时器:编号0,周期模式,500ms,空回调函数,无参数
	soft_timer_start(SOFT_TIMER_0_SCALE, SOFT_TIMER_MODE_PERIODIC, 500, scale_timer_callback, NULL, 0);
	soft_timer_start(SOFT_TIMER_2_MISC_TASK, SOFT_TIMER_MODE_PERIODIC, 1000, MiscTask, NULL, 0);
	for (;;)
	{
		// loop
		DisplayTask();	// 绘制显存
		OLED_Refresh(); // 显存发送

		AccTask(); // 姿态传感器读取

		ScaleTask(); // ADS1231读取

		BtnTask(); // 按钮检测

		// 更新软件定时器状态
		soft_timer_update();

		// 喂狗
		//HAL_WWDG_Refresh(&hwwdg);

	}
}
